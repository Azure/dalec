"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[620],{160:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>d,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var t=n(4848),r=n(8453);const a={title:"Targets"},s=void 0,o={id:"targets",title:"Targets",description:"This section provides an overview of the targets that Dalec supports. At this time, supported targets are mariner2, azlinux3, and windowscross.",source:"@site/docs/targets.md",sourceDirName:".",slug:"/targets",permalink:"/dalec/targets",draft:!1,unlisted:!1,editUrl:"https://github.com/Azure/dalec/blob/main/website/docs/targets.md",tags:[],version:"current",frontMatter:{title:"Targets"},sidebar:"sidebar",previous:{title:"Sources",permalink:"/dalec/sources"},next:{title:"Testing",permalink:"/dalec/testing"}},d={},l=[{value:"Available Targets",id:"available-targets",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"Extensibility",id:"extensibility",level:2},{value:"Advanced Customization",id:"advanced-customization",level:2},{value:"Worker images",id:"worker-images",level:3},{value:"Source Policies",id:"source-policies",level:4},{value:"Named Build Contexts",id:"named-build-contexts",level:4}];function c(e){const i={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(i.p,{children:["This section provides an overview of the targets that Dalec supports. At this time, supported targets are ",(0,t.jsx)(i.code,{children:"mariner2"}),", ",(0,t.jsx)(i.code,{children:"azlinux3"}),", and ",(0,t.jsx)(i.code,{children:"windowscross"}),"."]}),"\n",(0,t.jsxs)(i.p,{children:["Many components, such as package dependencies and base images, are specific to a distro or a subset of distros. The dalec spec allows you to move these distro specific things into a ",(0,t.jsx)(i.code,{children:"target"}),"."]}),"\n",(0,t.jsx)(i.h2,{id:"available-targets",children:"Available Targets"}),"\n",(0,t.jsx)(i.p,{children:"To print a list of available build targets:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-shell",children:"GET                           DESCRIPTION\nazlinux3/container (default)     Builds a container image with azlinux3 as the base image.\nazlinux3/container/depsonly      Builds a container image with only the runtime dependencies installed.\nazlinux3/rpm                     Builds an rpm and src.rpm.\nazlinux3/rpm/debug/buildroot     Outputs an rpm buildroot suitable for passing to rpmbuild.\nazlinux3/rpm/debug/sources       Outputs all the sources specified in the spec file in the format given to rpmbuild.\nazlinux3/rpm/debug/spec          Outputs the generated RPM spec file\nazlinux3/worker                  Builds the base worker image responsible for building the rpm\ndebug/gomods                     Outputs all the gomodule dependencies for the spec\ndebug/resolve                    Outputs the resolved dalec spec file with build args applied.\ndebug/sources                    Outputs all sources from a dalec spec file.\nmariner2/container (default)     Builds a container image with mariner2 as the base image.\nmariner2/container/depsonly      Builds a container image with only the runtime dependencies installed.\nmariner2/rpm                     Builds an rpm and src.rpm.\nmariner2/rpm/debug/buildroot     Outputs an rpm buildroot suitable for passing to rpmbuild.\nmariner2/rpm/debug/sources       Outputs all the sources specified in the spec file in the format given to rpmbuild.\nmariner2/rpm/debug/spec          Outputs the generated RPM spec file\nmariner2/worker                  Builds the base worker image responsible for building the rpm\nwindowscross/container (default) Builds binaries and installs them into a Windows base image\nwindowscross/worker              Builds the base worker image responsible for building the rpm\nwindowscross/zip                 Builds binaries combined into a zip file\n"})}),"\n",(0,t.jsx)(i.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,t.jsx)(i.p,{children:"Instead of specifying a package dependency at the root of the spec, you can specify it under a target.\nThis allows you to include different packages for different targets."}),"\n",(0,t.jsx)(i.admonition,{type:"note",children:(0,t.jsx)(i.p,{children:"Please note that dependencies under a target will override dependencies at the root level."})}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yaml",children:"targets:\n  mariner2:\n    dependencies:\n      build:\n        - golang\n"})}),"\n",(0,t.jsx)(i.h2,{id:"extensibility",children:"Extensibility"}),"\n",(0,t.jsx)(i.p,{children:"Dalec can\u2019t feasibly support every Linux distribution. Instead, it gives you the flexibility to specify a custom builder image for any target, directing the build process to that specified image."}),"\n",(0,t.jsxs)(i.p,{children:["This method allows for the use of a single spec file for all targets, employing one ",(0,t.jsx)(i.code,{children:"#syntax="})," directive to build the package for any specified target. It also permits the replacement of the default targets with custom builder configurations."]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-yaml",children:"targets:\n  mariner2:\n    frontend:\n      image: docker.io/my/custom:mariner2\n"})}),"\n",(0,t.jsx)(i.h2,{id:"advanced-customization",children:"Advanced Customization"}),"\n",(0,t.jsx)(i.h3,{id:"worker-images",children:"Worker images"}),"\n",(0,t.jsx)(i.p,{children:"In some cases you may need to have additional things installed in the worker\nimage that are not typically available in the base image. As an example, a\npackage dependency may not be available in the default package repositories."}),"\n",(0,t.jsxs)(i.p,{children:["You can have Dalec output an image with the target's worker image with\n",(0,t.jsx)(i.code,{children:"<target>/worker>"})," build target, e.g. ",(0,t.jsx)(i.code,{children:"--target=mariner2/worker"}),". You can then\nadd any customizations and feed that back in via ",(0,t.jsx)(i.a,{href:"#source-policies",children:"source polices"}),"\nor ",(0,t.jsx)(i.a,{href:"#named-build-contexts",children:"named build contexts"}),"."]}),"\n",(0,t.jsx)(i.h4,{id:"source-policies",children:"Source Policies"}),"\n",(0,t.jsxs)(i.p,{children:[(0,t.jsx)(i.code,{children:"docker buildx build"})," has experimental support for providing a\n",(0,t.jsx)(i.a,{href:"https://docs.docker.com/build/building/variables/#experimental_buildkit_source_policy",children:"source policy"}),"\nwhich updates the base image ref used to create the worker image. This method\nwill update any and all references to the matched image used for any part of\nthe build. It also requires knowing the image(s) that are used ahead of time and\ncreating the right set of match rules and potentially having to update this in\nthe future if the worker image refs in Dalec change."]}),"\n",(0,t.jsxs)(i.p,{children:["A finer grained approach is to use ",(0,t.jsx)(i.a,{href:"#named-build-contexts",children:"named build contexts"}),"."]}),"\n",(0,t.jsx)(i.h4,{id:"named-build-contexts",children:"Named Build Contexts"}),"\n",(0,t.jsxs)(i.p,{children:[(0,t.jsx)(i.code,{children:"docker buildx build"})," has a flag called ",(0,t.jsx)(i.code,{children:"--build-context"}),"\n(",(0,t.jsx)(i.a,{href:"https://docs.docker.com/reference/cli/docker/buildx/build/#build-context",children:"doc"}),")\nwhich allows you to provide additional build contexts apart from the main build\ncontext in the form of ",(0,t.jsx)(i.code,{children:"<name>=<ref>"}),". See the prior linked documentation for\nwhat can go into ",(0,t.jsx)(i.code,{children:"<ref>"}),"."]}),"\n",(0,t.jsxs)(i.p,{children:["In the ",(0,t.jsx)(i.code,{children:"mariner2"})," target, Dalec looks for a named context called either"]}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsxs)(i.li,{children:["The actual base image used internally for mariner2\ni. ",(0,t.jsx)(i.code,{children:"--build-context mcr.microsoft.com/cbl-mariner/base/core:2.0=<new ref>"})]}),"\n",(0,t.jsxs)(i.li,{children:["A build context named ",(0,t.jsx)(i.code,{children:"dalec-mariner2-worker"}),"\ni. ",(0,t.jsx)(i.code,{children:"--build-context dalec-mariner2-worker=<new ref>"})]}),"\n"]}),"\n",(0,t.jsx)(i.p,{children:"If 1 is provided, then 2 is ignored."}),"\n",(0,t.jsxs)(i.p,{children:["This works the same way in the ",(0,t.jsx)(i.code,{children:"azlinux3"}),":"]}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsxs)(i.li,{children:["The actual base image used internally for azlinux3\ni. ",(0,t.jsx)(i.code,{children:"--build-context mcr.microsoft.com/azurelinux/base/core:3.0=<new ref>"})]}),"\n",(0,t.jsxs)(i.li,{children:["A build context named ",(0,t.jsx)(i.code,{children:"dalec-mariner2-worker"}),"\ni. ",(0,t.jsx)(i.code,{children:"--build-context dalec-azlinux3-worker=<new ref>"})]}),"\n"]})]})}function u(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453:(e,i,n)=>{n.d(i,{R:()=>s,x:()=>o});var t=n(6540);const r={},a=t.createContext(r);function s(e){const i=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function o(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(a.Provider,{value:i},e.children)}}}]);