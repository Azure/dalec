"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[68],{3824:(e,n,c)=>{c.r(n),c.d(n,{assets:()=>t,contentTitle:()=>d,default:()=>o,frontMatter:()=>r,metadata:()=>s,toc:()=>h});const s=JSON.parse('{"id":"caches","title":"Caches","description":"In addition to the standard step-level caching that buildkit provides, you can","source":"@site/docs/caches.md","sourceDirName":".","slug":"/caches","permalink":"/dalec/caches","draft":false,"unlisted":false,"editUrl":"https://github.com/Azure/dalec/blob/main/website/docs/caches.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Extra Repository Configs","permalink":"/dalec/repositories"},"next":{"title":"Signing Packages","permalink":"/dalec/signing"}}');var a=c(4848),i=c(8453);const r={},d="Caches",t={},h=[{value:"Dir Cache",id:"dir-cache",level:2},{value:"Gobuild Cache",id:"gobuild-cache",level:2},{value:"Bazel Cache",id:"bazel-cache",level:2}];function l(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"caches",children:"Caches"})}),"\n",(0,a.jsxs)(n.p,{children:["In addition to the standard step-level caching that buildkit provides, you can\nalso configure incremental caching that persists across builds.\nThis is similar to Dockerfiles ",(0,a.jsx)(n.code,{children:"--mount=type=cache"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"You can provide multiple cache configurations:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"caches:\n  - dir:\n      key: my_key\n      dest: /my/cache/dir\n      sharing: shared\n  - dir:\n      key: my_other_key\n      dest: /my/other/cache/dir\n      sharing: private\n  - gobuild:\n  - bazel:\n"})}),"\n",(0,a.jsx)(n.h2,{id:"dir-cache",children:"Dir Cache"}),"\n",(0,a.jsx)(n.p,{children:"Dir caches are just generic directories where you choose the cache key and sharing mode."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"caches:\n  - dir:\n      key: my_key\n      dest: /my/cache/dir\n      sharing: shared\n"})}),"\n",(0,a.jsx)(n.p,{children:"Supported sharing modes are:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"shared"}),": The cache is shared between all builds."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"private"}),": The cache is private to the build."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"locked"}),": The cache is locked to the build. This is useful for caching directories that are not thread-safe."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["By default, dalec will namespace these directories with a key tied to the OS and\nCPU architecture which is prepended to the key you provide. This is to help\nprevent common issues one would see for specific use-cases such as storing\nincrmental compiler caches.\nYou can disable this behavior by setting the ",(0,a.jsx)(n.code,{children:"no_auto_namespace"})," option to ",(0,a.jsx)(n.code,{children:"true"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"caches:\n  - dir:\n      key: my_key\n      dest: /my/cache/dir\n      sharing: shared\n      no_auto_namespace: true\n"})}),"\n",(0,a.jsx)(n.p,{children:"This will disable the automatic namespacing and use the key you provide as-is."}),"\n",(0,a.jsx)(n.h2,{id:"gobuild-cache",children:"Gobuild Cache"}),"\n",(0,a.jsxs)(n.p,{children:["The gobuild cache is a special type of cache that is used to cache the results of\nthe ",(0,a.jsx)(n.code,{children:"go build"})," command.\nThis is useful for caching the results of the build, such as the binary or\nlibraries."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"caches:\n  - gobuild:\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Go build caches are always in ",(0,a.jsx)(n.code,{children:"shared"})," mode and are always namespaced with the OS and CPU architecture."]}),"\n",(0,a.jsxs)(n.p,{children:["An optional ",(0,a.jsx)(n.code,{children:"scope"})," can be provided which is added to the generated cache key.\nThis is intended for internal testing purposes, however may be useful for other\nuse-cases as well."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"caches:\n  - gobuild:\n      scope: my_scope\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Finally, when go is detected in the build environment dalec will automatically\ncreate a gobuild cache for you. This can be disabled by setting the ",(0,a.jsx)(n.code,{children:"disabled"}),"\noption to ",(0,a.jsx)(n.code,{children:"true"})," in the cache definition."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"caches:\n  - gobuild:\n      disabled: true\n"})}),"\n",(0,a.jsx)(n.h2,{id:"bazel-cache",children:"Bazel Cache"}),"\n",(0,a.jsxs)(n.p,{children:["The bazel cache is a special type of cache that is used to cache the results of\nthe ",(0,a.jsx)(n.code,{children:"bazel build"})," command."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"caches:\n  - bazel:\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Bazel caches are always in ",(0,a.jsx)(n.code,{children:"shared"})," mode and are always namespaced with the OS and CPU architecture.\nThis relies on setting the ",(0,a.jsx)(n.code,{children:"--disk_cache"})," flag on ",(0,a.jsx)(n.code,{children:"bazel build"})," by adding it to the ",(0,a.jsx)(n.em,{children:"system"})," bazelrc file\nwhen dalec sets up the build environment.\nDalec does not check if this is overwritten in the user or project bazelrc files.\nIf this conflicts with your project, you may need to manually manage the bazel cache with a ",(0,a.jsx)(n.a,{href:"#dir-cache",children:"cache dir"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["An optional ",(0,a.jsx)(n.code,{children:"scope"})," can be provided which is added to the generated cache key.\nThis is intended for internal testing purposes, however may be useful for other\nuse-cases as well."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"caches:\n  - bazel:\n      scope: my_scope\n"})})]})}function o(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},8453:(e,n,c)=>{c.d(n,{R:()=>r,x:()=>d});var s=c(6540);const a={},i=s.createContext(a);function r(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);