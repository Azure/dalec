# syntax=cpuguy83/rpmbundle

args:
  RUNC_COMMIT:
  GO_MD2MAN_COMMIT: d97078115282836e16d0dca10b4b42ce60fc70e6
  REVISION: 1
  VERSION:

name: moby-runc
description: A CLI tool for spawning and running containers according to the OCI specification.
website: https://www.runc.io
version: ${VERSION}
revision: ${REVISION}
vendor: Moby

dependencies:
  build:
    libseccomp-devel:
    libtool-ltdl-devel:
    which:
    gcc:
    golang:
      - ">= 1.19"
    go-md2man:
    libtool:
    make:
    pkgconfig:
    tar:
  runtime:
    libseccomp:
      - ">= 2.3"
    "/bin/sh":
packager: Microsoft <support@microsoft.com>
license: Apache 2.0
conflicts:
  runc:
  runc-io:
  containerd.io:
provides:
  - runc
sources:
  src:
    ref: https://github.com/opencontainers/runc.git#${RUNC_COMMIT}
  go-md2man:
    ref: https://github.com/cpuguy83/go-md2man.git#${GO_MD2MAN_COMMIT}
    satisfies:
      - go-md2man
  golang:
    ref: docker-image://mcr.microsoft.com/oss/go/microsoft/golang:1.20
    path: /usr/local/go
    satisfies:
      - golang
build:
  env:
    GOPROXY: direct
    CGO_ENABLED: 1 
    GOGC: off
    GOFLAGS: -trimpath
  steps:
    - command: |
        ls -lh
        export PATH="$(pwd)/golang/go/bin:${PATH}"
        export GOROOT="$(pwd)/golang/go"
        make -C go-md2man
        export PATH="$(pwd)/go-md2man/bin:${PATH}"
        cd src
        make man runc BUILDTAGS=seccomp

        cp runc "${DALEC_OUTPUT_DIR}/bin/"
        cp -r man/man8 ${DALEC_OUTPUT_DIR}/man/man8
