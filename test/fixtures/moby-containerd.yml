# syntax=ghcr.io/azure/dalec/frontend:latest

# TODO: The spec is not currently setting the revision in the containerd version
# This should be fixed before this spec is used to build a real package.

args:
  CONTAINERD_COMMIT:
  REVISION: 1
  VERSION:
  HCS_SHIM_REPO: https://github.com/Microsoft/hcsshim.git

name: moby-containerd
description: |
  Industry-standard container runtime
   containerd is an industry-standard container runtime with an emphasis on
   simplicity, robustness and portability. It is available as a daemon for Linux
   and Windows, which can manage the complete container lifecycle of its host
   system: image transfer and storage, container execution and supervision,
   low-level storage and network attachments, etc.
   .
   containerd is designed to be embedded into a larger system, rather than being
   used directly by developers or end-users.
website: https://containerd.io/
version: ${VERSION}
revision: ${REVISION}
vendor: Moby

targets: # Distro specific build requirements
  windows:
    dependencies:
      build:
        golang:
        jq:

packager: Microsoft <support@microsoft.com>
license: Apache 2.0
sources:
  containerd:
    git:
      url: https://github.com/containerd/containerd.git
      commit: "${CONTAINERD_COMMIT}"

build:
  env:
    CGO_ENABLED: 1
    GOOS: windows
    GOGC: "off"
    GOPROXY: "off"
    GOFLAGS: -trimpath
    GOROOT: /usr/lib/golang
    VERSION: ${VERSION}
    COMMIT: ${CONTAINERD_COMMIT}
  steps:
    - command: |
        set -e
        cd containerd
        make VERSION="$VERSION" REVISION="$COMMIT" binaries
        rm bin/containerd-stress.exe
        mkdir -p ../_output
        mv bin/* ../_output
    - command: |
        set -e
        cd containerd
        shim_mod_dir="$(
          go mod download -json github.com/Microsoft/hcsshim | jq -r '.Dir'
        )"
        mv "$shim_mod_dir" ../hcsshim
        cd ../hcsshim
        GO111MODULE=on go build \
          -mod=vendor \
          -o ../_output/containerd-shim-runhcs-v1.exe

artifacts:
  binaries:
    _output/containerd.exe:
    _output/containerd-shim-runhcs-v1.exe:
    # etc...
